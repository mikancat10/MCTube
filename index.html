<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCSearch - Video Browser</title>
    <style>
        :root { --bg: #f9f9f9; --card: #fff; --border: #e4e6ea; --text: #0f0f0f; --sub: #606060; --accent: #ff0000; }
        body { margin: 0; background: var(--bg); font-family: "Roboto", "Arial", sans-serif; color: var(--text); }
        
        /* Layout */
        .topbar { position: sticky; top: 0; background: #fff; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 8px 16px; z-index: 100; }
        .logo { font-weight: 700; font-size: 22px; cursor: pointer; letter-spacing: -1px; }
        .search-container { flex: 0 1 600px; display: flex; align-items: center; }
        .search-container input { width: 100%; padding: 10px 16px; border-radius: 20px 0 0 20px; border: 1px solid var(--border); outline: none; font-size: 16px; }
        .search-container button { border-radius: 0 20px 20px 0; border: 1px solid var(--border); border-left: none; background: #f8f8f8; padding: 10px 20px; cursor: pointer; }
        
        .layout { display: grid; grid-template-columns: 240px 1fr; }
        .sidebar { background: #fff; height: calc(100vh - 56px); position: sticky; top: 56px; padding: 12px; overflow-y: auto; }
        .sideitem { padding: 12px; border-radius: 10px; margin-bottom: 4px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; }
        .sideitem:hover { background: #f2f2f2; }
        .sideitem.active { background: #e5e5e5; font-weight: bold; }

        .content { padding: 24px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        
        /* Components */
        .card { background: none; border: none; cursor: pointer; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 12px; background: #eee; }
        .card-info { margin-top: 10px; }
        .card-title { font-weight: 600; font-size: 14px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-meta { font-size: 12px; color: var(--sub); margin-top: 4px; }

        /* Watch Page */
        .watch { display: grid; grid-template-columns: 1fr 350px; gap: 24px; max-width: 1400px; margin: 0 auto; }
        .player-container { width: 100%; }
        .player-wrapper { position: relative; padding-top: 56.25%; background: #000; border-radius: 12px; overflow: hidden; }
        .player-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        
        @media (max-width: 1000px) {
            .layout { grid-template-columns: 1fr; }
            .sidebar { display: none; }
            .watch { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="topbar">
    <div class="logo" onclick="location.hash='';">MC<span style="color:var(--accent)">Tube</span></div>
    <div class="search-container">
        <input id="q" placeholder="Ê§úÁ¥¢" onkeypress="if(event.key==='Enter')search()">
        <button onclick="search()">üîç</button>
    </div>
    <div style="width: 40px;"></div>
</div>

<div class="layout">
    <div class="sidebar">
        <div class="sideitem active" id="menu-home" onclick="location.hash=''; updateMenu(this)">üè† „Éõ„Éº„É†</div>
        <div class="sideitem" id="menu-history" onclick="showHistoryPage(); updateMenu(this)">‚è≥ Â±•Ê≠¥</div>
    </div>
    <div class="content" id="app">
        </div>
</div>

<script>
// --- Ë®≠ÂÆö ---
const API_KEY = "AIzaSyARTqbVFa9iHvXlyHlDZVtpyfO4kxz6_yU"; // ‚ÄªÂèñÂæó„Åó„ÅüAPI„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ

// --- „É´„Éº„Çø„Éº ---
window.addEventListener('hashchange', router);
window.addEventListener('load', router);

function router() {
    const h = location.hash;
    const app = document.getElementById('app');
    
    if (h.startsWith('#watch=')) {
        openWatch(h.split('=')[1]);
    } else if (h.startsWith('#channel=')) {
        openChannel(h.split('=')[1]);
    } else {
        openHome();
    }
}

// --- Ê©üËÉΩÈñ¢Êï∞ ---
function updateMenu(el) {
    document.querySelectorAll('.sideitem').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
}

async function search() {
    const q = document.getElementById('q').value;
    if (!q) return;
    
    location.hash = ''; // „Éõ„Éº„É†„Å∏ÁßªÂãï
    const app = document.getElementById('app');
    app.innerHTML = '<div class="grid" id="results">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';

    try {
        const r = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=20&q=${encodeURIComponent(q)}&key=${API_KEY}`);
        const d = await r.json();
        renderVideoGrid(d.items, 'results');
    } catch (e) {
        app.innerHTML = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇAPI„Ç≠„Éº„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
    }
}

function renderVideoGrid(items, targetId) {
    const box = document.getElementById(targetId);
    if (!items || items.length === 0) { box.innerHTML = "ÁµêÊûú„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ"; return; }
    
    box.innerHTML = items.map(v => `
        <div class="card" onclick="location.hash='#watch=${v.id.videoId || v.id}'">
            <img src="${v.snippet.thumbnails.medium.url}" alt="thumbnail">
            <div class="card-info">
                <div class="card-title">${escapeHtml(v.snippet.title)}</div>
                <div class="card-meta">${v.snippet.channelTitle}</div>
            </div>
        </div>
    `).join('');
}

function openHome() {
    document.getElementById('app').innerHTML = '<h2>„Åä„Åô„Åô„ÇÅ</h2><div class="grid" id="results">Ê§úÁ¥¢„Éê„Éº„Åã„ÇâÂãïÁîª„ÇíÊé¢„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ</div>';
}

async function openWatch(id) {
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="watch">
            <div class="player-container">
                <div class="player-wrapper">
                    <iframe src="https://www.youtube.com/embed/${id}?autoplay=1" allowfullscreen></iframe>
                </div>
                <h2 id="v-title">Ë™≠„ÅøËæº„Åø‰∏≠...</h2>
                <div id="v-channel" class="meta"></div>
                <hr>
                <div class="comments">
                    <h4>„Ç≥„É°„É≥„Éà</h4>
                    <textarea id="commentText" style="width:100%; height:60px; border-radius:8px; padding:8px;" placeholder="ÂÖ¨Èñã„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ..."></textarea>
                    <button onclick="postComment('${id}')" style="margin-top:8px; padding:8px 16px; border-radius:18px; border:none; background:#065fd4; color:#fff; cursor:pointer;">„Ç≥„É°„É≥„Éà</button>
                    <div id="commentList" style="margin-top:20px;"></div>
                </div>
            </div>
            <div class="related" id="related"></div>
        </div>`;

    try {
        const r = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${id}&key=${API_KEY}`);
        const d = await r.json();
        const v = d.items[0];
        document.getElementById('v-title').textContent = v.snippet.title;
        document.getElementById('v-channel').innerHTML = `<strong>${v.snippet.channelTitle}</strong>`;
        
        saveHistory(id, v.snippet);
        loadRelated(id);
        loadComments(id);
    } catch (e) {
        console.error("Video load failed", e);
    }
}

function saveHistory(id, s) {
    let h = JSON.parse(localStorage.getItem('history') || '[]');
    h = h.filter(v => v.id !== id);
    h.unshift({ id, title: s.title, thumb: s.thumbnails.medium.url });
    localStorage.setItem('history', JSON.stringify(h.slice(0, 40)));
}

function showHistoryPage() {
    location.hash = '#history';
    const h = JSON.parse(localStorage.getItem('history') || '[]');
    const app = document.getElementById('app');
    app.innerHTML = '<h2>Ë¶ñËÅ¥Â±•Ê≠¥</h2><div class="grid" id="his"></div>';
    renderVideoGrid(h.map(item => ({ id: item.id, snippet: { title: item.title, thumbnails: { medium: { url: item.thumb } }, channelTitle: 'Â±•Ê≠¥„Åã„Çâ' } })), 'his');
}

function postComment(id) {
    const t = document.getElementById('commentText').value.trim();
    if (!t) return;
    const k = 'c_' + id;
    const l = JSON.parse(localStorage.getItem(k) || '[]');
    l.unshift({ text: t, date: new Date().toLocaleString() });
    localStorage.setItem(k, JSON.stringify(l));
    document.getElementById('commentText').value = '';
    loadComments(id);
}

function loadComments(id) {
    const l = JSON.parse(localStorage.getItem('c_' + id) || '[]');
    document.getElementById('commentList').innerHTML = l.map(c => `
        <div style="margin-bottom:12px; font-size:14px; border-bottom:1px solid #eee; padding-bottom:8px;">
            <div style="color:var(--sub); font-size:11px;">„É¶„Éº„Ç∂„Éº ‚Ä¢ ${c.date || ''}</div>
            <div style="margin-top:4px;">${escapeHtml(c.text)}</div>
        </div>
    `).join('');
}

async function loadRelated(id) {
    // Ê≥®: YouTube API„ÅÆ‰ªïÊßòÂ§âÊõ¥„Å´„Çà„ÇäÈñ¢ÈÄ£ÂãïÁîª(relatedToVideoId)„ÅØÂà∂Èôê„Åï„Çå„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô
    const r = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=8&key=${API_KEY}`);
    const d = await r.json();
    const box = document.getElementById('related');
    box.innerHTML = '<h4>Ê¨°„ÅÆÂãïÁîª</h4>' + d.items.map(v => `
        <div style="display:flex; gap:8px; margin-bottom:12px; cursor:pointer;" onclick="location.hash='#watch=${v.id.videoId}'">
            <img src="${v.snippet.thumbnails.medium.url}" style="width:140px; border-radius:8px;">
            <div style="font-size:12px; font-weight:bold; overflow:hidden;">${escapeHtml(v.snippet.title)}</div>
        </div>
    `).join('');
}

function escapeHtml(str) {
    const p = document.createElement('p');
    p.textContent = str;
    return p.innerHTML;
}
</script>
</body>
</html>
